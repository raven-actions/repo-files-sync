---
name: Prerelease

on:
  workflow_run:
    workflows: [CI]
    types:
      - completed
    branches:
      - main

permissions: {}

concurrency:
  group: prerelease-${{ github.event.workflow_run.head_branch || 'main' }}
  cancel-in-progress: false

jobs:
  build:
    name: Build
    runs-on: ubuntu-24.04
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: .node-version
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run build command
        run: pnpm build

      - name: Upload build artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: dist
          path: dist/
          retention-days: 1

  prerelease:
    name: Prerelease
    needs: [build]
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Get release details
        id: release-details
        uses: orhun/git-cliff-action@d77b37db2e3f7398432d34b72a12aa3e2ba87e51 # v4.6.0
        with:
          config: .github/cliff.toml
          args: --unreleased --bump --strip header

      - name: Download build artifact
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: dist
          path: dist/

      - name: Prepare Release Branch
        id: release-branch
        run: |
          set -euo pipefail

          # Validate release tag
          if [[ -z "${RELEASE_TAG}" ]]; then
            echo "::error::Release tag is empty"
            exit 1
          fi

          # Validate required files exist
          for file in LICENSE README.md action.yml .github/workflows/publish.yml; do
            if [[ ! -f "$file" ]]; then
              echo "::error::Required file missing: $file"
              exit 1
            fi
          done

          # Validate dist directory has files
          if [[ ! -d "dist" ]] || [[ -z "$(ls -A dist 2>/dev/null)" ]]; then
            echo "::error::dist directory is empty or missing"
            exit 1
          fi

          RELEASE_BRANCH="release/${RELEASE_TAG}"

          # Delete branch if it exists (remotely)
          gh api --method DELETE "/repos/${GITHUB_REPOSITORY}/git/refs/heads/${RELEASE_BRANCH}" 2>/dev/null || true

          # Helper: GitHub API call with standard headers
          gh_api() {
            gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$@"
          }

          # Helper: Create blob from file
          create_blob() {
            local tmpfile
            tmpfile=$(mktemp)
            printf '{"content":"%s","encoding":"base64"}' "$(base64 -w 0 "$1")" > "$tmpfile"
            gh_api --method POST "/repos/${GITHUB_REPOSITORY}/git/blobs" --input "$tmpfile" --jq '.sha'
            rm -f "$tmpfile"
          }

          # Helper: Create tree from JSON entries
          create_tree() {
            gh_api --method POST "/repos/${GITHUB_REPOSITORY}/git/trees" --input - <<< "$1" | jq -r '.sha'
          }

          # Get the current HEAD commit SHA from main branch (parent for new commit)
          echo "Getting main branch HEAD..."
          PARENT_SHA=$(gh_api "/repos/${GITHUB_REPOSITORY}/git/ref/heads/main" --jq '.object.sha')

          # Create blobs for required files
          echo "Creating blobs..."
          LICENSE_BLOB=$(create_blob "LICENSE")
          README_BLOB=$(create_blob "README.md")
          ACTION_BLOB=$(create_blob "action.yml")
          PUBLISH_BLOB=$(create_blob ".github/workflows/publish.yml")

          # Build dist tree entries
          DIST_ENTRIES=""
          for file in dist/*; do
            [[ -f "$file" ]] || continue
            filename=$(basename "$file")
            blob=$(create_blob "$file")
            [[ -n "$DIST_ENTRIES" ]] && DIST_ENTRIES+=","
            DIST_ENTRIES+="{\"path\":\"${filename}\",\"mode\":\"100644\",\"type\":\"blob\",\"sha\":\"${blob}\"}"
          done

          # Create all trees
          echo "Creating trees..."
          DIST_TREE=$(create_tree "{\"tree\":[${DIST_ENTRIES}]}")
          WORKFLOWS_TREE=$(create_tree "{\"tree\":[{\"path\":\"publish.yml\",\"mode\":\"100644\",\"type\":\"blob\",\"sha\":\"${PUBLISH_BLOB}\"}]}")
          GITHUB_TREE=$(create_tree "{\"tree\":[{\"path\":\"workflows\",\"mode\":\"040000\",\"type\":\"tree\",\"sha\":\"${WORKFLOWS_TREE}\"}]}")
          ROOT_TREE=$(create_tree "{\"tree\":[
            {\"path\":\"LICENSE\",\"mode\":\"100644\",\"type\":\"blob\",\"sha\":\"${LICENSE_BLOB}\"},
            {\"path\":\"README.md\",\"mode\":\"100644\",\"type\":\"blob\",\"sha\":\"${README_BLOB}\"},
            {\"path\":\"action.yml\",\"mode\":\"100644\",\"type\":\"blob\",\"sha\":\"${ACTION_BLOB}\"},
            {\"path\":\"dist\",\"mode\":\"040000\",\"type\":\"tree\",\"sha\":\"${DIST_TREE}\"},
            {\"path\":\".github\",\"mode\":\"040000\",\"type\":\"tree\",\"sha\":\"${GITHUB_TREE}\"}
          ]}")

          # Create commit with parent from main (will be verified)
          echo "Creating verified commit..."
          COMMIT_SHA=$(gh_api --method POST "/repos/${GITHUB_REPOSITORY}/git/commits" \
            -f message="chore(release): ${RELEASE_TAG}" \
            -f tree="${ROOT_TREE}" \
            -f "parents[]=${PARENT_SHA}" \
            --jq '.sha')

          # Create branch ref pointing to the new commit
          echo "Creating release branch..."
          gh_api --method POST "/repos/${GITHUB_REPOSITORY}/git/refs" \
            -f ref="refs/heads/${RELEASE_BRANCH}" \
            -f sha="${COMMIT_SHA}"

          echo "name=${RELEASE_BRANCH}" >> "$GITHUB_OUTPUT"
          echo "Created release branch ${RELEASE_BRANCH} from main with verified commit ${COMMIT_SHA}"
        env:
          RELEASE_TAG: ${{ steps.release-details.outputs.version }}
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Create Draft Prerelease
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ steps.release-details.outputs.version }}
          name: ${{ steps.release-details.outputs.version }}
          body: ${{ steps.release-details.outputs.content }}
          draft: true
          prerelease: true
          generate_release_notes: false
          target_commitish: ${{ steps.release-branch.outputs.name }}
